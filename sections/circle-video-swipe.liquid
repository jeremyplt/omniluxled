{%- unless product.handle == 'omnilux-men' or product.handle == 'omnilux-contour-neck-decollete' or product.handle == 'omnilux-contour-glove' %}
<style>
  .circle-video-menu--{{ section.id }} .circle-video-menu-item-image {
    border-color: {{ section.settings.border_color }};
  }
</style>

<div class="circle-video-swipe circle-video-menu-wrap circle-video-menu-wrap--{{ section.id }} {{ section.settings.div_id }}{% if section.settings.desktop %} circle-video-desktop{% endif %}">
    <div class="circle-video-menu circle-video-menu--{{ section.id }} {% if section.settings.ignore %}circle-vide-menu--ignore{% endif %}">
        <div class="circle-menu-items">
        {% for block in section.blocks %}
            <a class="circle-video-menu-item">
            <span class="circle-video-menu-item-image">
                {{ block.settings.image | image_url: width: 350 | image_tag: class: 'circle-menu-item-img', loading: "lazy" }}
                {% render 'icon-play' %}
            </span>
            <span class="circle-menu-item-label">{{ block.settings.label }}</span>
            </a>
        {% endfor %}
        </div>
    </div>

    <div class="circle-video-swipe__modal">
        <div class="circle-video-swipe__slider keen-slider">
            {% for block in section.blocks %}
                <div class="circle-video__item keen-slider__slide video--pause">
                    <div class="loading-spinner"></div>
                    {{ block.settings.video | video_tag: autoplay: true, preload: "metadata" }}
                </div>
            {% endfor %}
        </div>
        <div class="modal__controls">
            <div class="modal__button modal__sound">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                </svg>
            </div>
            <div class="modal__button modal__close">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </div>
        </div>
        <div class="modal__swipe-animation">
            <span style="margin-bottom: 1rem;">Swipe up</span>
            {% comment %} <iframe src="https://lottie.host/embed/7e8cdc85-0dc4-4086-af5e-e4b1f5b55f62/X6onBgMQvk.json" style="transform: rotate(180deg)" ></iframe> {% endcomment %}
            <span style="transform: rotate(180deg)">
              <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script> 
              <dotlottie-player src="https://lottie.host/9e15963a-59ab-415c-ac89-6fa66ca3baa1/Q84skeKrwV.json" background="transparent" speed="3" style="width: 100px; height: 100px;" loop autoplay></dotlottie-player>
            </span>
        </div>
    </div>
</div>

<script>

  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.querySelector('.circle-video-swipe__modal');
    const videos = modal.querySelectorAll('.circle-video__item video');
    let slider;

    function hideSpinner(video) {
      const spinner = video.parentElement.querySelector('.loading-spinner');
      if (spinner) spinner.classList.add('hidden');
    }

    function showSpinner(video) {
      const spinner = video.parentElement.querySelector('.loading-spinner');
      if (spinner) spinner.classList.remove('hidden');
    }

    function playVideo(video) {
      video.muted = false;
      video.play().then(() => {
        hideSpinner(video);
        video.parentElement.classList.remove('video--pause');
      }).catch((error) => {
        console.error('Video playback failed:', error);
        showSpinner(video);
      });
    }

    videos.forEach(video => {
      video.addEventListener('loadedmetadata', () => hideSpinner(video));
      video.addEventListener('waiting', () => showSpinner(video));
      video.addEventListener('canplay', () => hideSpinner(video));

      video.addEventListener('click', () => {
        if (video.paused) {
          playVideo(video);
        } else {
          video.pause();
          video.parentElement.classList.add('video--pause');
        }
      });
    });

    document.querySelectorAll('.circle-video-menu--{{ section.id }} .circle-video-menu-item').forEach((item, i) => {
      item.addEventListener('click', () => {
        document.documentElement.style.overflow = 'hidden';
        document.querySelector("body").style.overflow = 'hidden';
        modal.classList.add('modal--active');

        if (!slider) {
          slider = new KeenSlider(".circle-video-swipe__slider", {
            vertical: true,
            slideChanged: (s) => {
              const slide = s.track.details.rel;
              videos.forEach((video, index) => {
                if (index === slide) {
                  playVideo(video);
                } else {
                  video.pause();
                  video.parentElement.classList.add('video--pause');
                }
              });
            },
          });
        }

        slider.moveToIdx(i);
        playVideo(videos[i]);

        setTimeout(() => {
          document.querySelector('.modal__swipe-animation').style.display = "none";
        }, 6000);
      });
    });
  
    document.querySelector('.circle-video-swipe__modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('circle-video-swipe__modal')) {
        const modal = document.querySelector('.circle-video-swipe__modal');
        document.documentElement.style.overflow = 'auto';
        document.querySelector("body").style.overflow = 'auto';
        modal.classList.remove('modal--active');
        modal.querySelectorAll('video').forEach(video => video.pause());
      }
    });
  
    document.querySelector(".modal__close").addEventListener("click", () => {
      const modal = document.querySelector('.circle-video-swipe__modal');
      document.documentElement.style.overflow = 'auto';
      document.querySelector("body").style.overflow = 'auto';
      modal.classList.remove('modal--active');
      modal.querySelectorAll('video').forEach(video => video.pause());
    });
  
    document.querySelector(".modal__sound").addEventListener("click", () => {
      const isMuted = document.querySelector(".modal__sound").classList.toggle("muted");
      videos.forEach(video => {
        video.muted = isMuted;
        video.volume = isMuted ? 0 : 1;
      });
    });
  })
</script>

{%- endunless -%}

{% schema %}
{
  "name": "Circle video swipe",
  "class": "circle-video-menu-wrap-wrap",
  "settings": [
    {
      "label": "Border color",
      "id": "border_color",
      "type": "color",
      "default": "#000000"
    },
    {
          "label": "Section Product ID",
          "id": "div_id",
          "type": "text"
        },
    {
      "label": "Ignore theme fonts",
      "id": "ignore",
      "type": "checkbox",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "desktop",
      "label": "Desktop"
    }
  ],
  "blocks": [
    {
      "name": "Circle link",
      "type": "circle-link",
      "settings": [
        {
          "label": "Image",
          "id": "image",
          "type": "image_picker"
        },
        {
          "label": "Label",
          "id": "label",
          "type": "text"
        },
        {
          "label": "Video url",
          "id": "video",
          "type": "video"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Circle video swipe"
    }
  ]
}
{% endschema %}